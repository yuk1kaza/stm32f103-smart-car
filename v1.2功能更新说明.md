# v1.2 功能更新说明

## 更新日期
2025年12月11日

---

## 新增功能

### 1. 站点停靠功能 ✨

**功能描述**：
- 小车检测到全黑线（5个传感器都检测到黑线）时，自动停靠
- 默认停靠时间：10秒
- 停靠时上报站点编号
- 停靠后自动恢复前进

**实现细节**：
```c
// 检测全黑线（站点）
if(sensors == 0x1F)  // 0b11111
{
    Station_Stop(stop_time_seconds);
    return;
}
```

**串口输出**：
```
STATUS:STOP,STATION:1    // 停靠在第1个站点
STATUS:FORWARD           // 10秒后恢复前进
```

### 2. 停靠时间设置功能 ⚙️

**功能描述**：
- 可通过蓝牙命令设置停靠时间（1-9秒）
- 在停止模式下发送数字键1-9即可设置
- 设置后立即生效

**使用方法**：
```
发送: 0    // 进入停止模式
发送: 5    // 设置停靠时间为5秒
返回: STOP_TIME_SET:5
发送: 1    // 进入循迹模式
```

### 3. 状态上报功能 📡

**功能描述**：
- 每秒自动上报当前运行状态
- 循迹模式：上报"FORWARD"
- 手动模式：上报"MANUAL"
- 停靠时：上报"STOP,STATION:X"

**串口输出示例**：
```
STATUS:FORWARD
STATUS:FORWARD
STATUS:STOP,STATION:1
STATUS:FORWARD
STATUS:MANUAL
```

### 4. 状态查询功能 🔍

**功能描述**：
- 发送 `Q` 命令查询当前状态
- 返回：模式、站点数、停靠时间

**使用方法**：
```
发送: Q
返回: MODE:1,STATION:3,STOP_TIME:10
```

**返回值说明**：
- MODE: 0=停止, 1=循迹, 2=手动, 3=避障
- STATION: 已停靠的站点数
- STOP_TIME: 停靠时间（秒）

---

## 代码改动

### 新增变量
```c
uint16_t station_count = 0;        // 已停靠站点数
uint8_t stop_time_seconds = 10;    // 停靠时间（秒）
```

### 新增函数
```c
void Station_Stop(uint8_t stop_seconds);  // 站点停靠函数
```

### 修改函数
```c
void Line_Tracking_PID(void);      // 添加站点停靠逻辑
void Bluetooth_Process(void);      // 添加参数设置命令
```

### 主循环改动
```c
// 添加定时状态上报（每1秒）
static uint32_t last_report_time = 0;
if(HAL_GetTick() - last_report_time >= 1000)
{
    // 上报状态
}
```

---

## 命令列表更新

### 原有命令
| 命令 | 功能 |
|------|------|
| `0` | 停止模式 |
| `1` | 循迹模式 |
| `2` | 手动模式 |
| `F/f` | 前进（手动模式） |
| `B/b` | 后退（手动模式） |
| `L/l` | 左转（手动模式） |
| `R/r` | 右转（手动模式） |
| `S/s` | 停止 |
| `U/u` | 超声波测距 |

### 新增命令
| 命令 | 功能 | 返回 |
|------|------|------|
| `Q/q` | 查询状态 | `MODE:X,STATION:X,STOP_TIME:X` |
| `1-9` | 设置停靠时间 | `STOP_TIME_SET:X` |

---

## 使用示例

### 示例1：基础循迹+站点停靠

```
1. 连接蓝牙
2. 发送: 1          // 进入循迹模式
3. 小车沿黑线行驶
4. 到达站点（全黑线）
   串口输出: STATUS:STOP,STATION:1
5. 停靠10秒
6. 自动恢复前进
   串口输出: STATUS:FORWARD
```

### 示例2：自定义停靠时间

```
1. 发送: 0          // 停止模式
2. 发送: 3          // 设置停靠3秒
   返回: STOP_TIME_SET:3
3. 发送: 1          // 循迹模式
4. 到达站点时停靠3秒
```

### 示例3：查询运行状态

```
发送: Q
返回: MODE:1,STATION:2,STOP_TIME:10

解释：
- 当前处于循迹模式
- 已停靠2个站点
- 停靠时间设置为10秒
```

---

## 测试建议

### 测试1：站点停靠
1. 在赛道上放置一条宽≥10cm的全黑线
2. 小车行驶到全黑线时应停靠
3. 观察串口输出和停靠时间

### 测试2：多站点
1. 放置3个站点（3条全黑线）
2. 观察小车依次停靠
3. 检查站点计数是否正确

### 测试3：时间设置
1. 设置不同的停靠时间（1-9秒）
2. 验证实际停靠时间是否准确

### 测试4：状态上报
1. 打开串口助手
2. 观察每秒的状态上报
3. 验证状态是否正确

---

## 注意事项

### 1. 站点标记要求
- 全黑线宽度：≥10cm
- 确保5个传感器都能检测到
- 黑线要足够黑，对比度要高

### 2. 停靠时间限制
- 当前只支持1-9秒
- 如需10秒以上，需修改代码
- 建议停靠时间不超过30秒

### 3. 串口波特率
- 必须设置为115200
- 数据位：8
- 停止位：1
- 校验位：无

### 4. 状态上报频率
- 当前为每秒1次
- 如需调整，修改主循环中的时间间隔

---

## 已知问题

### 问题1：OLED功能暂时禁用
- **原因**：OLED库与HAL库存在头文件冲突
- **状态**：待修复
- **影响**：不影响其他功能

### 问题2：停靠时间精度
- **描述**：使用HAL_Delay，精度约±100ms
- **影响**：停靠10秒实际可能为9.9-10.1秒
- **解决**：可接受范围内

---

## 下一步计划

### v1.3 计划功能
- [ ] 修复OLED头文件冲突
- [ ] 添加OLED倒计时显示
- [ ] 支持更长的停靠时间（通过串口设置）
- [ ] 添加多路线选择功能
- [ ] 集成超声波避障到循迹模式

### v2.0 计划功能
- [ ] 开发上位机控制程序
- [ ] 添加WiFi通信
- [ ] 添加摄像头视觉识别
- [ ] 多车协同功能

---

## 文档更新

### 已更新文档
- ✅ README.md - 添加新功能说明
- ✅ 项目需求与解决方案.md - 完整技术方案
- ✅ Git协作规范.md - 分支合并详解
- ✅ CHANGELOG.md - 版本历史
- ✅ 功能测试指南.md - 测试方法

### 新增文档
- ✅ 文档导航.md - 快速查找文档
- ✅ v1.2功能更新说明.md - 本文件

---

## 反馈与支持

### 问题反馈
- GitHub Issues: [提交问题](https://github.com/your-username/stm32-smart-car/issues)
- 邮箱: weiyongxin2004@163.com

### 贡献代码
- 欢迎提交Pull Request
- 请遵循[Git协作规范](Git协作规范.md)

---

**版本**：v1.2.0  
**发布日期**：2025年12月11日  
**作者**：项目团队
