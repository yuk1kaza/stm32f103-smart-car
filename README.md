# STM32F103 智能循迹小车

基于STM32F103C8的智能小车项目，具有PID循迹、蓝牙控制、超声波测距等功能。

## 项目简介

stm32f103_car_v1.0智能小车，集成L298N电机驱动、两个直流电机、HC-SR04超声波模块、五路红外循迹传感器、HC-05蓝牙模块和OLED显示屏，实现了精确的PID循迹控制、远程蓝牙遥控和超声波测距功能。

## 硬件配置

### 主控芯片
- STM32F103C8T6

### 引脚连接

#### 电机驱动 (L298N)
- PA0 (TIM2_CH1) → PWM输入端INA (左电机PWM)
- PA3 (TIM2_CH4) → PWM输入端INB (右电机PWM)
- PA1 → IN1 (左电机方向控制)
- PA2 → IN2 (左电机方向控制)
- PA4 → IN3 (右电机方向控制)
- PA5 → IN4 (右电机方向控制)

#### 红外循迹传感器
- PB0 → LEFT1 (左外传感器)
- PB1 → LEFT2 (左内传感器)
- PB3 → MID (中间传感器)
- PB4 → RIGHT2 (右内传感器)
- PB5 → RIGHT1 (右外传感器)

#### 超声波模块
- PB14 → TRIG (触发信号)
- PB15 → ECHO (回响信号)

#### OLED屏幕 (I2C)
- PB6 → SCL (I2C时钟)
- PB7 → SDA (I2C数据)

#### 蓝牙模块 (HC-05)
- PA9 → TX (USART1_TX)
- PA10 → RX (USART1_RX)
- VCC → 5V
- GND → GND
- 波特率：115200

## 功能特性

### 1. PID循迹控制
- 5路红外传感器阵列
- 完整PID算法（比例+积分+微分）
- 加权误差计算
- 差速转向控制
- 全黑/全白智能处理

### 2. 蓝牙远程控制
- HC-05蓝牙模块（波特率115200）
- 多模式切换：停止/循迹/手动/避障
- 手动遥控：前进/后退/左转/右转
- 实时命令响应

### 3. 超声波测距
- HC-SR04超声波模块
- 测距范围：2cm - 400cm
- 微秒级精确延时（TIM1）
- 串口调试输出

### 4. OLED显示（可选）
- 128x64 OLED屏幕
- I2C接口
- 实时状态显示

## 核心技术

### PID循迹算法
```c
// PID参数
Kp = 7.5f    // 比例系数：快速响应偏差
Ki = 0.05f   // 积分系数：消除稳态误差
Kd = 15.0f   // 微分系数：抑制震荡

// 传感器权重（加权误差计算）
左外: -80, 左内: -40, 中间: 0, 右内: 40, 右外: 80

// 差速控制
left_speed = BASE_SPEED + PID_output
right_speed = BASE_SPEED - PID_output
```

### PWM电机控制
- 定时器：TIM2
- PWM频率：100Hz
- 占空比范围：0-9999（0-100%）
- 基础速度：4000（40%）
- 最大速度：9999（100%）

### 超声波测距
- 触发脉冲：10μs
- 定时器：TIM1（1μs精度）
- 超时保护：30ms
- 距离计算：distance = (echo_time × 0.034) / 2

## 参数调整

### PID参数优化
当前配置（`Core/Src/main.c`）：
```c
#define BASE_SPEED  4000    // 基础速度：40%
#define KP  7.5f            // 比例系数
#define KI  0.05f           // 积分系数
#define KD  15.0f           // 微分系数
#define INTEGRAL_MAX 200.0f // 积分限幅
```

### 调整建议
| 问题 | 解决方案 |
|------|----------|
| 震荡严重 | 增大Kd (20-30) 或减小Kp (5-6) |
| 响应慢 | 增大Kp (10-15) |
| 转弯不够急 | 增大BASE_SPEED或允许电机反转 |
| 长期偏离中线 | 增大Ki (0.1-0.5) 或INTEGRAL_MAX (500-1000) |
| 速度太快 | 降低BASE_SPEED (2000-3000) |

## 开发环境

- IDE: Keil MDK-ARM (Keil5)
- 配置工具: STM32CubeMX
- 调试工具: ST-Link / USB转TTL

## 编译和烧录

1. 打开 `MDK-ARM/test1119.uvprojx`
2. 编译项目 (F7)
3. 使用ST-Link烧录到STM32

## 使用指南

### 蓝牙控制

1. **连接蓝牙**
   - 手机搜索"HC-05"
   - 配对密码：1234
   - 使用串口助手连接

2. **命令列表**

| 命令 | 功能 | 说明 |
|------|------|------|
| `0` | 停止模式 | 电机停止 |
| `1` | 循迹模式 | 启动PID循迹 |
| `2` | 手动模式 | 切换到遥控模式 |
| `F` | 前进 | 仅手动模式有效 |
| `B` | 后退 | 仅手动模式有效 |
| `L` | 左转 | 仅手动模式有效 |
| `R` | 右转 | 仅手动模式有效 |
| `S` | 停止 | 任何模式都可停止 |
| `U` | 超声波测距 | 返回距离数据 |

### 超声波测距

1. **连接串口**
   - 波特率：115200
   - 连接PA9(TX)和PA10(RX)到USB转TTL

2. **测试方法**
   - 发送蓝牙命令 `U`
   - 串口返回距离数据

3. **返回格式**
   ```
   Distance: 25.34 cm        // 正常测距
   Distance: ERROR (Timeout) // 超时或无障碍物
   ```

### 循迹使用

1. **准备赛道**
   - 白色底面 + 黑色线条
   - 线宽：2-3cm
   - 传感器距地面：0.5-1cm

2. **启动循迹**
   - 发送命令 `1` 进入循迹模式
   - 小车自动沿黑线行驶
   - 遇到全黑线（终点）自动停止

3. **调试技巧**
   - 观察小车是否震荡 → 调整Kd
   - 观察转弯是否跟上 → 调整Kp或BASE_SPEED
   - 使用串口输出调试信息（可选）

## 故障排查

### 循迹问题
| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 小车震荡严重 | Kp过大或Kd过小 | 减小Kp或增大Kd |
| 转弯跟不上 | 速度太快或Kp太小 | 降低BASE_SPEED或增大Kp |
| 只能右转不能左转 | 速度限幅问题 | 检查代码是否允许速度降到0 |
| 偏离中线 | 积分项太小 | 增大Ki或INTEGRAL_MAX |

### 硬件问题
| 问题 | 检查项 |
|------|--------|
| 电机不转 | 检查L298N供电、PWM连接、方向引脚 |
| 传感器无响应 | 检查传感器供电、引脚连接、高度调整 |
| 蓝牙无法连接 | 检查HC-05供电、TX/RX是否交叉连接 |
| 超声波超时 | 检查TIM1配置（Prescaler=71）、TRIG/ECHO连接 |

## 注意事项

1. **JTAG禁用**：代码中已禁用JTAG以释放PB3、PB4引脚，保留SWD调试功能
2. **电源要求**：电机和STM32分别供电，务必共地
3. **PWM频率**：TIM2 Prescaler=71，实现100Hz PWM频率
4. **微秒延时**：TIM1 Prescaler=71，实现1μs精度延时

## 作者

- 邮箱: weiyongxin2004@163.com

## 许可证

MIT License

## 技术亮点

- ✅ **完整PID算法**：比例+积分+微分，带积分限幅防饱和
- ✅ **加权误差计算**：5路传感器加权求和，精确定位
- ✅ **差速转向控制**：左右电机独立调速，实现平滑转向
- ✅ **智能边界处理**：全黑停止、全白保持方向
- ✅ **多模式运行**：停止/循迹/手动/避障模式切换
- ✅ **蓝牙远程控制**：实时命令响应，支持遥控和调试
- ✅ **精确超声波测距**：微秒级延时，超时保护
- ✅ **100Hz PWM控制**：平滑电机运行，无明显噪音

## 更新日志

### v1.2 (2025-12-11)
- 🐛 修复循迹左转问题（速度限幅逻辑）
- 🐛 修复传感器权重符号错误
- ⚡ 优化PID参数（Kp=7.5, Kd=15.0）
- ⚡ 允许速度降到0，实现更大转向差速
- 📝 简化项目文档，整合到README

### v1.1 (2025-12-10)
- ✨ 新增HC-05蓝牙控制功能
- ✨ 实现多模式运行（停止/循迹/手动/避障）
- ✨ 新增HC-SR04超声波测距功能
- ✨ 实现串口调试输出
- 🔧 修复PWM频率问题（1Hz→100Hz）
- 🔧 修复TIM1配置（实现1μs精度延时）
- 🔧 修复注释乱码问题

### v1.0 (2025-12-03)
- 🎉 初始版本
- ✨ 实现红外循迹功能
- ✨ 实现PID控制算法
- ✨ 添加多种调试模式
