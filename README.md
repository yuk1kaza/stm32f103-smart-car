# STM32F103 智能循迹小车

基于STM32F103C8的智能小车项目，具有PID循迹、蓝牙控制、超声波测距等功能。

## 项目简介

stm32f103_car_v1.0智能小车，集成L298N电机驱动、两个直流电机、HC-SR04超声波模块、五路红外循迹传感器、HC-05蓝牙模块和OLED显示屏，实现了精确的PID循迹控制、远程蓝牙遥控和超声波测距功能。

### 项目需求

本项目满足以下功能需求：

**下位机（STM32）**：
1. 使用循迹模块检测路线，沿路线行走，遇到地面站点停靠10秒
2. OLED屏显示前进、停靠状态
3. 通过串口与上位机通讯，传输运行状态

**上位机（PC/手机）**：
1. 手动控制小车运行状态（前进、后退、左转、右转）
2. 循迹运行时显示前进、停靠状态
3. 可设置串口参数（端口、波特率、数据位、停止位、校验位）

**进阶功能**（可选）：
- OLED显示运动方向、车速、站点数量、倒计时
- 多路线循迹支持
- 超声波避障功能
- 上位机参数设置（停靠时间、车速）
- 停靠历史记录

📖 **详细需求和解决方案**：请查看 [项目需求与解决方案.md](项目需求与解决方案.md)

## 硬件配置

### 主控芯片
- STM32F103C8T6

### 引脚连接

#### 电机驱动 (L298N)
- PA0 (TIM2_CH1) → PWM输入端INA (左电机PWM)
- PA3 (TIM2_CH4) → PWM输入端INB (右电机PWM)
- PA1 → IN1 (左电机方向控制)
- PA2 → IN2 (左电机方向控制)
- PA4 → IN3 (右电机方向控制)
- PA5 → IN4 (右电机方向控制)

#### 红外循迹传感器
- PB0 → LEFT1 (左外传感器)
- PB1 → LEFT2 (左内传感器)
- PB3 → MID (中间传感器)
- PB4 → RIGHT2 (右内传感器)
- PB5 → RIGHT1 (右外传感器)

#### 超声波模块
- PB14 → TRIG (触发信号)
- PB15 → ECHO (回响信号)

#### OLED屏幕 (I2C)
- PB6 → SCL (I2C时钟)
- PB7 → SDA (I2C数据)

#### 蓝牙模块 (HC-05)
- PA9 → TX (USART1_TX)
- PA10 → RX (USART1_RX)
- VCC → 5V
- GND → GND
- 波特率：115200

## 功能特性

### 1. PID循迹控制
- 5路红外传感器阵列
- 完整PID算法（比例+积分+微分）
- 加权误差计算
- 差速转向控制
- 全黑/全白智能处理
- 站点停靠功能（10秒倒计时）

### 2. 蓝牙远程控制
- HC-05蓝牙模块（波特率115200）
- 多模式切换：停止/循迹/手动/避障
- 手动遥控：前进/后退/左转/右转
- 速度等级切换：慢速(20%)/中速(40%)/快速(60%)
- 实时命令响应

### 3. 超声波测距
- HC-SR04超声波模块
- 测距范围：2cm - 400cm
- 微秒级精确延时（TIM1）
- 串口调试输出

### 4. OLED实时显示
- 128x64 OLED屏幕（I2C接口）
- 实时显示运动方向（前进/后退/左转/右转/停止）
- 显示车速等级和百分比
- 显示已停靠站点数
- 停靠时显示倒计时（10秒递减）
- 显示超声波距离
- 刷新频率：200ms（5Hz）

### 5. 高频状态上报
- 上报频率：10Hz（每100ms）
- 完整状态信息：模式、方向、速度、站点、距离
- 数据格式：`STATUS:MODE=1,DIR=1,SPEED=1,STATION=3,DIST=25.3\r\n`
- 带宽占用：~5%
- 实时性：延迟<100ms

## 核心技术

### PID循迹算法
```c
// PID参数
Kp = 7.5f    // 比例系数：快速响应偏差
Ki = 0.05f   // 积分系数：消除稳态误差
Kd = 15.0f   // 微分系数：抑制震荡

// 传感器权重（加权误差计算）
左外: -80, 左内: -40, 中间: 0, 右内: 40, 右外: 80

// 差速控制
left_speed = BASE_SPEED + PID_output
right_speed = BASE_SPEED - PID_output
```

### PWM电机控制
- 定时器：TIM2
- PWM频率：100Hz
- 占空比范围：0-9999（0-100%）
- 基础速度：4000（40%）
- 最大速度：9999（100%）

### 超声波测距
- 触发脉冲：10μs
- 定时器：TIM1（1μs精度）
- 超时保护：30ms
- 距离计算：distance = (echo_time × 0.034) / 2

## 参数调整

### PID参数优化
当前配置（`Core/Src/main.c`）：
```c
#define BASE_SPEED  4000    // 基础速度：40%
#define KP  7.5f            // 比例系数
#define KI  0.05f           // 积分系数
#define KD  15.0f           // 微分系数
#define INTEGRAL_MAX 200.0f // 积分限幅
```

### 调整建议
| 问题 | 解决方案 |
|------|----------|
| 震荡严重 | 增大Kd (20-30) 或减小Kp (5-6) |
| 响应慢 | 增大Kp (10-15) |
| 转弯不够急 | 增大BASE_SPEED或允许电机反转 |
| 长期偏离中线 | 增大Ki (0.1-0.5) 或INTEGRAL_MAX (500-1000) |
| 速度太快 | 降低BASE_SPEED (2000-3000) |

## 开发环境

- IDE: Keil MDK-ARM (Keil5)
- 配置工具: STM32CubeMX
- 调试工具: ST-Link / USB转TTL

## 编译和烧录

1. 打开 `MDK-ARM/test1119.uvprojx`
2. 编译项目 (F7)
3. 使用ST-Link烧录到STM32

## 使用指南

### 蓝牙控制

1. **连接蓝牙**
   - 手机搜索"HC-05"
   - 配对密码：1234
   - 使用串口助手连接

2. **命令列表**

| 命令 | 功能 | 说明 |
|------|------|------|
| `0` | 停止模式 | 电机停止 |
| `1` | 循迹模式 | 启动PID循迹 |
| `2` | 手动模式 | 切换到遥控模式 |
| `F` | 前进 | 仅手动模式有效 |
| `B` | 后退 | 仅手动模式有效 |
| `L` | 左转 | 仅手动模式有效 |
| `R` | 右转 | 仅手动模式有效 |
| `S` | 停止 | 任何模式都可停止 |
| `+` | 加速 | 提升速度等级 |
| `-` | 减速 | 降低速度等级 |
| `Q` | 查询状态 | 返回完整状态信息 |
| `U` | 超声波测距 | 返回距离数据 |

### OLED显示

**显示内容**（4行信息）：
```
Dir: FORWARD      ← 运动方向
Speed:MID 40%     ← 车速等级
Stations: 3       ← 停靠站点数
Dist: 25.3cm      ← 超声波距离
```

**停靠时显示**：
```
Dir: STOP         ← 停止状态
Speed:MID 40%     ← 车速等级
Stations: 3       ← 站点数+1
Countdown: 7s     ← 倒计时递减
```

### 高频状态上报

**数据格式**：
```
STATUS:MODE=1,DIR=1,SPEED=1,STATION=3,DIST=25.3\r\n
```

**字段说明**：
- `MODE`: 运行模式（0=停止，1=循迹，2=手动，3=避障）
- `DIR`: 运动方向（0=停止，1=前进，2=后退，3=左转，4=右转）
- `SPEED`: 速度等级（0=慢速20%，1=中速40%，2=快速60%）
- `STATION`: 已停靠站点数
- `DIST`: 超声波距离（cm）

**上报频率**：10Hz（每100ms一次）

**Python解析示例**：
```python
import serial
import re

def parse_status(line):
    pattern = r'STATUS:MODE=(\d+),DIR=(\d+),SPEED=(\d+),STATION=(\d+),DIST=([\d.]+)'
    match = re.match(pattern, line)
    if match:
        return {
            'mode': int(match.group(1)),
            'direction': int(match.group(2)),
            'speed': int(match.group(3)),
            'station': int(match.group(4)),
            'distance': float(match.group(5))
        }
    return None

ser = serial.Serial('COM3', 115200)
while True:
    line = ser.readline().decode('utf-8').strip()
    if line.startswith('STATUS:'):
        data = parse_status(line)
        if data:
            print(f"模式:{data['mode']} 方向:{data['direction']} "
                  f"速度:{data['speed']} 站点:{data['station']} "
                  f"距离:{data['distance']:.1f}cm")
```

### 超声波测距

1. **连接串口**
   - 波特率：115200
   - 连接PA9(TX)和PA10(RX)到USB转TTL

2. **测试方法**
   - 发送蓝牙命令 `U`
   - 串口返回距离数据

3. **返回格式**
   ```
   Distance: 25.34 cm        // 正常测距
   Distance: ERROR (Timeout) // 超时或无障碍物
   ```

### 循迹使用

1. **准备赛道**
   - 白色底面 + 黑色线条
   - 线宽：2-3cm
   - 传感器距地面：0.5-1cm

2. **启动循迹**
   - 发送命令 `1` 进入循迹模式
   - 小车自动沿黑线行驶
   - 遇到全黑线（终点）自动停止

3. **调试技巧**
   - 观察小车是否震荡 → 调整Kd
   - 观察转弯是否跟上 → 调整Kp或BASE_SPEED
   - 使用串口输出调试信息（可选）

## 故障排查

### 循迹问题
| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 小车震荡严重 | Kp过大或Kd过小 | 减小Kp或增大Kd |
| 转弯跟不上 | 速度太快或Kp太小 | 降低BASE_SPEED或增大Kp |
| 只能右转不能左转 | 速度限幅问题 | 检查代码是否允许速度降到0 |
| 偏离中线 | 积分项太小 | 增大Ki或INTEGRAL_MAX |

### 硬件问题
| 问题 | 检查项 |
|------|--------|
| 电机不转 | 检查L298N供电、PWM连接、方向引脚 |
| 传感器无响应 | 检查传感器供电、引脚连接、高度调整 |
| 蓝牙无法连接 | 检查HC-05供电、TX/RX是否交叉连接 |
| 超声波超时 | 检查TIM1配置（Prescaler=71）、TRIG/ECHO连接 |

## 注意事项

1. **JTAG禁用**：代码中已禁用JTAG以释放PB3、PB4引脚，保留SWD调试功能
2. **电源要求**：电机和STM32分别供电，务必共地
3. **PWM频率**：TIM2 Prescaler=71，实现100Hz PWM频率
4. **微秒延时**：TIM1 Prescaler=71，实现1μs精度延时

## 作者

- 邮箱: weiyongxin2004@163.com

## 项目文档

### 📚 文档导航
- 🗺️ [文档导航](文档导航.md) - **快速找到你需要的文档**

### 核心文档
- 📋 [项目需求与解决方案](项目需求与解决方案.md) - **完整的需求分析和技术实现方案**
  - 需求分析（基础+进阶）
  - 系统架构设计
  - 详细实现方案
  - 上位机设计
  - 进阶功能扩展
  - 参考资源和附录
  
- 🔧 [Git协作规范](Git协作规范.md) - **团队协作和分支管理指南**
  - Git工作流程
  - 分支管理策略
  - 冲突处理方法
  - 合并最佳实践
  - 实战场景演练

### 配置文件
- `.gitignore` - Git忽略规则
- `test1119.ioc` - STM32CubeMX配置文件

## 许可证

MIT License

## 技术亮点

### 控制算法
- ✅ **完整PID算法**：比例+积分+微分，带积分限幅防饱和
- ✅ **加权误差计算**：5路传感器加权求和，精确定位
- ✅ **差速转向控制**：左右电机独立调速，实现平滑转向
- ✅ **智能边界处理**：全黑停止、全白保持方向

### 系统功能
- ✅ **多模式运行**：停止/循迹/手动/避障模式切换
- ✅ **蓝牙远程控制**：实时命令响应，支持遥控和调试
- ✅ **精确超声波测距**：微秒级延时，超时保护
- ✅ **100Hz PWM控制**：平滑电机运行，无明显噪音

### 代码质量
- ✅ **模块化设计**：功能模块独立，易于维护
- ✅ **完整注释**：中文注释，易于理解
- ✅ **错误处理**：超时保护、边界检查
- ✅ **可配置参数**：PID参数、速度等级可调

## 快速开始

### 1. 克隆项目
```bash
git clone https://github.com/your-username/stm32-smart-car.git
cd stm32-smart-car
```

### 2. 硬件连接
按照[引脚连接](#引脚连接)部分连接硬件

### 3. 编译烧录
1. 打开 `MDK-ARM/test1119.uvprojx`
2. 编译项目（F7）
3. 使用ST-Link烧录

### 4. 测试运行
1. 连接蓝牙（HC-05，密码1234）
2. 发送命令 `1` 启动循迹模式
3. 将小车放在黑线上，开始循迹

## 项目结构

```
stm32-smart-car/
├── Core/                      # 核心代码
│   ├── Inc/                   # 头文件
│   │   ├── main.h
│   │   ├── gpio.h
│   │   ├── tim.h
│   │   └── ...
│   └── Src/                   # 源文件
│       ├── main.c             # 主程序（PID循迹、蓝牙控制）
│       ├── gpio.c
│       ├── tim.c
│       └── ...
├── Drivers/                   # HAL库驱动
│   ├── CMSIS/
│   └── STM32F1xx_HAL_Driver/
├── MDK-ARM/                   # Keil项目
│   ├── test1119.uvprojx      # Keil项目文件
│   └── HardWare/             # 硬件驱动（OLED等）
├── 项目需求与解决方案.md      # 详细技术方案
├── Git协作规范.md             # 团队协作指南
├── README.md                  # 本文件
└── .gitignore                # Git忽略规则
```

## 更新日志

完整的更新日志请查看 [CHANGELOG.md](CHANGELOG.md)

### v1.2.1 (2025-12-17) - 当前版本
- ✨ 启用电机反转功能，允许原地转向
- ⚡ 提升急转弯能力和转向灵活性
- 📝 添加电机反转功能说明文档

### v1.2.0 (2025-12-17)
- ✨ 新增OLED实时显示功能（方向、速度、站点、倒计时）
- ✨ 新增高频状态上报（10Hz，完整状态信息）
- ✨ 新增速度等级切换功能（慢速/中速/快速）
- ✨ 新增站点停靠倒计时显示
- 📝 添加完整的项目需求与解决方案文档
- 📝 完善Git协作规范（分支合并详解）
- 🐛 修复循迹左转问题和传感器权重错误
- ⚡ 优化PID参数，提高响应速度

### v1.1.0 (2025-12-10)
- ✨ 新增蓝牙控制和超声波测距功能
- 🔧 修复PWM频率和TIM1配置问题

### v1.0.0 (2025-12-03)
- 🎉 初始版本，实现基础循迹功能

## 贡献指南

欢迎贡献代码！请遵循以下步骤：

1. Fork本项目
2. 创建功能分支（`git checkout -b feature/AmazingFeature`）
3. 提交更改（`git commit -m '添加某个功能'`）
4. 推送到分支（`git push origin feature/AmazingFeature`）
5. 创建Pull Request

详细的协作规范请查看 [Git协作规范.md](Git协作规范.md)

## 常见问题

### Q: 编译时出现头文件冲突错误？
A: 确保所有文件使用HAL库头文件（`stm32f1xx_hal.h`），不要混用标准库（`stm32f10x.h`）

### Q: 小车只能右转不能左转？
A: 检查速度限幅逻辑，确保允许速度降到0。参考v1.2更新日志。

### Q: 蓝牙无法连接？
A: 检查HC-05供电（5V），确认TX/RX交叉连接（STM32 TX → HC-05 RX）

### Q: 超声波测距总是超时？
A: 检查TIM1配置，Prescaler应为71（实现1μs精度）

### Q: 如何调整PID参数？
A: 参考[参数调整](#参数调整)部分，根据实际表现调整Kp、Ki、Kd

## 联系方式

- 作者邮箱: weiyongxin2004@163.com
- 项目地址: [GitHub](https://github.com/your-username/stm32-smart-car)
- 问题反馈: [Issues](https://github.com/your-username/stm32-smart-car/issues)
